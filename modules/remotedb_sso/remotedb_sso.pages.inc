<?php

/**
 * @file
 * Page callbacks.
 */

use Drupal\remotedb\Exception\RemotedbException;

/**
 * Login the specified user.
 *
 * @param int $remotedb_uid
 *   User ID from the central database.
 * @param int $timestamp
 *   Timestamp generated by the central database.
 * @param $hashes_pass
 *   Hash generated by the central database.
 *
 * @return void
 * @todo Implement as action?
 */
function remotedb_sso_login($remotedb_uid, $timestamp, $hashed_pass) {
  global $user;

  $target_path = remotedb_sso_target_path(func_get_args(), 3);

  if ($user->uid) {
    // A user is already logged in, so ignore the attempt and go to the
    // target url.
    drupal_goto($target_path);
  }

  if (!$remotedb_uid) {
    // The user anonymous, so ignore the attempt and go to the
    // target url.
    drupal_goto($target_path);
  }

  try {
    $ticket_service = remotedb_sso_get_ticket_service();
    if ($ticket_service) {
      $remote_account = $ticket_service->validateTicket($remotedb_uid, $timestamp, $hashed_pass);
      if ($remote_account) {
        // Ticket is valid. Update account data in local database.
        $account = $remote_account->toAccount();
        entity_save('user', $account);

        // Now login the user.
        $user = $account;
        user_login_finalize();
      }
    }
  }
  catch (RemotedbException $e) {
    // Log any remote database exceptions.
    $e->logError(WATCHDOG_WARNING);
  }
  drupal_goto($target_path);
}

/**
 * Redirect the user to the website they wish to login at.
 *
 * @param string $website
 *   The website to go to, without "http://".
 *
 * @return void
 * @todo Implement as action?
 */
function remotedb_sso_goto($website) {
  global $user;
  try {
    // Request a ticket from the central database.
    $ticket_service = remotedb_sso_get_ticket_service();
    if ($ticket_service) {
      $ticket = $ticket_service->getTicket($user);
      // Generate target path.
      $target_path = remotedb_sso_target_path(func_get_args());
      // Redirect.
      drupal_goto('http://' . $website . '/sso/login/' . $ticket . '/' . $target_path);
    }
  }
  catch (RemotedbException $e) {
    $e->printMessage();
    return '';
  }
}

/**
 * Generate a drupal path based on the given arguments.
 *
 * @param array $args
 *   An array of path parts.
 * @param int $count
 *   The number of arguments to ignore.
 *
 * @return string
 */
function remotedb_sso_target_path($args, $count = 1) {
  while ($count-- > 0) {
    array_shift($args);
  }
  $target_path = implode('/', $args);
  return $target_path;
}
